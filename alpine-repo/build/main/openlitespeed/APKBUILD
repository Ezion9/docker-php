# Contributor: Peter Kokot <peterkokot@gmail.com>
# Maintainer: Peter Kokot <peterkokot@gmail.com>

pkgname=openlitespeed
pkgver=1.4.26
pkgrel=1
_pkgreal=openlitespeed
_pkghome=var/lib/$_pkgreal
pkgdesc="High-performance, lightweight, open source HTTP server"
url="http://open.litespeedtech.com/"
arch="all !aarch64 !ppc64le"
license="GPL3"
pkgusers=lsadm
pkggroups=lsadm
depends=
depends_dev=
makedepends="php7.1-litespeed linux-headers openssl-dev geoip-dev expat-dev pcre-dev zlib-dev file udns-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-doc $pkgname-snmp::noarch"
source="http://open.litespeedtech.com/packages/openlitespeed-$pkgver.tgz
cgiconnection.cpp.patch
configure.patch
DAttrBase.php.patch
devpoller.h.patch
ediostream.cpp.patch
eventreactor.h.patch
fcgiconnection.cpp.patch
functions.sh.patch
httpd_config.conf.in.patch
httplistener.cpp.patch
httpsession.cpp.patch
install.sh.patch
jCryption.php.patch
ls_lock.c.patch
ls_lock.h.patch
lscgid.cpp.patch
lshttpdmain.cpp.patch
missing
multiplexer.cpp.patch
multiplexertest.h.patch
ntwkiolink.cpp.patch
openlitespeed.initd
pcutil.cpp.patch
poller.cpp.patch
pollfdreactor.cpp.patch
pthreadmutex.cpp.patch
RealTimeStats.php.patch
rtsigio.cpp.patch
thread.h.patch
"
builddir="$srcdir/$_pkgreal-$pkgver"

build() {
  cd "$builddir"

  install -Dm755 "$srcdir"/../missing \
    "$builddir"/missing || return 1

  ./configure \
    --host=$CHOST \
    --build=$CBUILD \
    --prefix=/var/lib/$_pkgreal \
    --with-user=$pkgusers \
    --with-group=$pkggroups \
    --enable-adminssl=no \
    --disable-rpath \
    --disable-static \
    --with-openssl=/usr \
    --with-expat \
    --with-pcre \
    --with-zlib \
    || return 1

  make || return 1
}

prepare() {
  cd "$builddir"

  default_prepare

  ln -sf /usr/bin/lsphp "$builddir"/dist/fcgi-bin/lsphp || return 1
  rm "$builddir"/dist/admin/misc/php.ini || return 1
  rm "$builddir"/dist/admin/conf/php.ini || return 1
}

check() {
  cd "$builddir"

  local allow_fail='yes'

  make test || [ "$allow_fail" = yes ] || return 1
}

package() {
  local file;
  replaces="litespeed"

  cd "$builddir"

  # Create necessary users
  sudo "$builddir"/../../$pkgname.pre-install

  make DESTDIR="$pkgdir" install || return 1

  mkdir -p "$pkgdir"/usr/lib/$_pkgreal \
    "$pkgdir"/usr/sbin \
    "$pkgdir"/var/log || return 1

  # Remove some not used files
  #rm -rf "$pkgdir"/$_pkghome/php* \
  #  "$pkgdir"/$_pkghome/lib \
  #  "$pkgdir"/$_pkghome/GPL* \
  #  "$pkgdir"/$_pkghome/gdata \
  #  "$pkgdir"/$_pkghome/autoupdate \
  #  "$pkgdir"/$_pkghome/fcgi-bin/* \
  #  "$pkgdir"/$_pkghome/bin/lshttpd \
  #  "$pkgdir"/$_pkghome/admin/misc/gdb-bt \
  #  "$pkgdir"/$_pkghome/admin/misc/convertxml.* \
  #  "$pkgdir"/$_pkghome/admin/misc/build_admin_php.sh \
  #  || return 1

  # fix permissions
  chown -R $pkgusers:$pkggroups \
    "$pkgdir"/$_pkghome/conf \
    "$pkgdir"/$_pkghome/admin/conf

  #chown -R $pkgusers:$pkggroups \
  #  "$pkgdir"/$_pkghome/tmp \
  #  "$pkgdir"/$_pkghome/conf \
  #  "$pkgdir"/$_pkghome/logs \
  #  "$pkgdir"/$_pkghome/backup \
  #  "$pkgdir"/$_pkghome/cachedata \
  #  "$pkgdir"/$_pkghome/admin/tmp \
  #  "$pkgdir"/$_pkghome/admin/logs \
  #  "$pkgdir"/$_pkghome/admin/conf \
  #  "$pkgdir"/$_pkghome/Example/logs || return 1

  # Install configs
  install -Dm755 "$srcdir"/$_pkgreal.initd \
    "$pkgdir"/etc/init.d/$_pkgreal || return 1
  mv "$pkgdir"/$_pkghome/conf \
    "$pkgdir"/etc/$_pkgreal || return 1
  mv "$pkgdir"/$_pkghome/admin/conf \
    "$pkgdir"/etc/$_pkgreal/admin || return 1
  ln -s /etc/$_pkgreal "$pkgdir"/$_pkghome/conf || return 1
  ln -s /etc/$_pkgreal/admin "$pkgdir"/$_pkghome/admin/conf || return 1
  find "$pkgdir"/etc/$_pkgreal -type f -print0 | xargs -0 chmod -x || return 1

  # Install binaries
  mv "$pkgdir"/$_pkghome/bin/$_pkgreal \
    "$pkgdir"/usr/sbin/lshttpd || return 1
  ln -sf /usr/sbin/lshttpd \
    "$pkgdir"/$_pkghome/bin/$_pkgreal || return 1
  ln -sf /usr/bin/lsphp \
    "$pkgdir"/$_pkghome/fcgi-bin/lsphp || return 1

  # Install modules
  for file in $(find "$pkgdir"/$_pkghome/modules -name "*.so"); do
    mv $file "$pkgdir"/usr/lib/$_pkgreal/${file##*/} || return 1
    ln -s /usr/lib/$_pkgreal/${file##*/} $file || return 1
  done

  # Install logs
  mv "$pkgdir"/$_pkghome/logs "$pkgdir"/var/log/$_pkgreal || return 1
  mv "$pkgdir"/$_pkghome/admin/logs "$pkgdir"/var/log/$_pkgreal/admin || return 1
  mv "$pkgdir"/$_pkghome/Example/logs "$pkgdir"/var/log/$_pkgreal/Example || return 1
  ln -s /var/log/$_pkgreal "$pkgdir"/$_pkghome/logs || return 1
  ln -s /var/log/$_pkgreal/admin "$pkgdir"/$_pkghome/admin/logs || return 1
  ln -s /var/log/$_pkgreal/Example "$pkgdir"/$_pkghome/Example/logs || return 1
}

doc() {
  default_doc

  mkdir -p "$subpkgdir"/var/lib/$_pkgreal/docs || return 1
  mv "$pkgdir"/$_pkghome/docs/* \
    "$subpkgdir"/$_pkghome/docs
}

snmp() {
  pkgdesc="$pkgdesc (snmp monitoring add-on + cacti templates)"
  depends="$pkgname net-snmp"

  mkdir -p "$subpkgdir"/$_pkghome/add-ons || return 1
  mv "$pkgdir"/$_pkghome/add-ons/snmp_monitoring \
    "$subpkgdir"/$_pkghome/add-ons
}
sha512sums="8689edf830380d4c14716ca406531fff98ede88d2467eb67cddb5c30bf1271b190b15a087c4ae7ef1841ffe76464133bd74056f61b9eec56331e0d37f05b99cb  openlitespeed-1.4.26.tgz
b93c745d458b3cad491cb100afbfc10ad4247cac16ba3db0cfbd87b35681ea5608e8939c6748ec05b6061d1ad1560bc2f12ba43299cd436490b43ffbc21b7800  cgiconnection.cpp.patch
be3b09fcf0bb09562f963680b32f2f3c20ab45ac97db28909e53f320db62bbbcda03a1f68bbb841d80502a61954d07cf1bce9ad8a5b1526b252a3320532800f6  configure.patch
cd4e35be9a1d95c0909ae8453a502a212909c914602d79508d1cb7815fcc5919e45db1cd357e369512640178501327960b82a4943a405758dd44438356a23f2b  DAttrBase.php.patch
1e527634c4350cf4b33cee54fe72bcb059f87a97e3029248185cad467ed70115df7087312c36343315d7028182e2bdf595e60e4166f24d91faf1b8c304b33917  devpoller.h.patch
b10c06fb9a82ded80466d523a9987c0fd27c2d8a3e8a308043a349021c83b01428b65939e4c30e8d450cb54e4acedca43c6972f33a6693407f16191ebfbce29e  ediostream.cpp.patch
82acb5409eeae5cea0ba7051f3a8db85c8ba55b04967b96a0258fdbd855f80c765a522e9243d06f94a8e351ac920483887919361ae80955ea99ae6914d300d29  eventreactor.h.patch
7d16decd3ddd91714d35292c81d422294a57d3702e1ec3a56fc6fccb8342627cb7fdbdf5121bbeb71734882d646cde51d8b23d7c84e9ea806fa4735ed6417b0f  fcgiconnection.cpp.patch
32d1d1c6f01fecdace5112e2481c4a93f4d23df2a9c308ad1c00139d2c8db7dc76c9f3709b6356feac1c3c5bb1a5fa840b5ad37c9fc02af983e63711b71be68b  functions.sh.patch
aa492ae54a6796286fe259beca9d643aba3d0fe5681278367a0ddb3b53525581faee9b7cbead030d5964ce895e88dd4814e4ead10d3f1b7cce4eececf7aa40d1  httpd_config.conf.in.patch
8c614c6c9818f947b2bdb7044e389eeeda3885b57b908573f0afeb46935c1508c23e2ae257af2ec92a5898e3a5d142da10b4d5ff2af7c282f52d35ffa39379eb  httplistener.cpp.patch
30c745201a656588eb8bcf0148e9d55eb64556741f97a0e8fccab7ce994ad5a853d5f4149aaadc875b570a19a3b4bee9bc2a4bca614e2765f50ec7e671f29d04  httpsession.cpp.patch
1fd729cb5959215f1cc5e7a7a7471af2f6f0f83f0f10d839da835f186bd19c82cb10e4adb0c0ce696e9dd2eb3774c149354b4beb7b4c85d5f1c8d8f20ec46f50  install.sh.patch
5ad509e1b3196360adc8680e1ffc34e10b3358e1c665f54156efe224c8b900b755de9046202e0ccb8c5f7df0fcef5a8b35f58914c59b4553858fb84df17da73c  jCryption.php.patch
40abc5dd03839225ac7228eab0b7b04e411442d1da3d51c31ec5e77b8628f1a146fa6131050e4318149f0c572f2e08f2e2ec48d755128bfbb2ab80b3854502a3  ls_lock.c.patch
48b083d0c8117747c29ee9884d935182268590e9174e4fae4de12524f2774099cab73519cd438ecb7318b9a03fa7dbebc8edfe81f82a342f6efb5534a7e9176a  ls_lock.h.patch
82e1f71e4e1be3e95a865e74cd2ec0cb6bf566f0ecfe6408b8ac8e0bbe42b8ba389f37fd6a58bd7c749e84a84e1ebada8699c04a2b687a6627deb180e8f285bb  lscgid.cpp.patch
6a38b58187d9c29b723e518946d67ff575452217fc6c15c9da23a5c780b6c7eab80ffa7ba1a8ed9737f5434a1dec6bd3fc6d87a030902b4a97efcc96de7b9f85  lshttpdmain.cpp.patch
665a4c151d87f7dbad121085539f9d7a6d7bfb70d6713f7138423157f94015a8fa4c129c9887024f3403d4eca4b57edaf2ec851a9e6d6663714c1901362280b2  missing
01aad3cbbab954ada49869c8b992d6a0a3ac3c4d10b3b929d3e8bf0fb866fb0435f0ab1f477e4d1385ec4447078ea150fe326387f369febd925535d0125a0a3e  multiplexer.cpp.patch
0f3230817f5e7c51c29193bf446e82eb56814a041cfd10fc61b8a49fadf53d19214a489dd120ffe9c4cc4b3839ead121be35bf5e9f08f4d11bb18b0f75e4d738  multiplexertest.h.patch
3ef7dc09abdf1400f2d6cce896cd2fefed9e171ac51726bbffbf3297a0641503c0f1d085d559001b2b28dc5a71d5a9845fc715b865762ca64cdc8791b713a721  ntwkiolink.cpp.patch
98db2641e62c509485f0996f2dec7304e0b2bf38878ace60438719e56588d903f29a0ce3a8399ff94770ab4e079e55e218fd8357d98c269d2c03e13363a49145  openlitespeed.initd
b12e63b9cf1dbc873d7fc7f1fc9e99764ad9b26f0bc15577e5a2a9e9214d65df82d286a13228534be49085e10c9402a6d1a895023f1377eb1caf5d4df5cd7fa6  pcutil.cpp.patch
e49a721ef0ba12c04f9a4207230245abd1c0e3ec32ddada14af78c17abaecdcb722c191d9bddb81f547954b455bfa47285da9724dea01aacecf3302df491e71d  poller.cpp.patch
e6a7acdd61439a01646ac215986677dfc5fde4e990f6ccfd27d43cf7f312ea6560f58412bb3e2ca2473504c85f729f21a2920f5fe39d4269b76f9866dc964f3e  pollfdreactor.cpp.patch
f06ac74ce6c45f3f7e141007daf6ebf5da23576a9fe28c0a1ed5bd78295a7e1320aa041eeeea949611e6fcff760b7264c052af89e1465acebcdbb3f11628ae20  pthreadmutex.cpp.patch
e50d56b0ca507f07c9704002d1716b7fe6e644a4a3f3ba6d0d91cd25134fb75a8e1ff1270b11051b83978b6fe5d736ff35dbfd7ce65dde6512749d1c769a3ea2  RealTimeStats.php.patch
709a20f40d357b195d1b077cfd99a4ee63293893343cfe82a8a0335c14d6f44affc0b159383c8a3dac777ab3384eec7031ab3ac4c286f9d50604a6b418ab300f  rtsigio.cpp.patch
a025d765f1c40caa1a67a91d68fbc727fae315a3511f74196c891326067992e8b1e5b2830863239fe80da465d79c5ab203752dfb692fa796f8958e1b11b5b2c5  thread.h.patch"
