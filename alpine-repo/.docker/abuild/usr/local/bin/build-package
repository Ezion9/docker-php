#!/bin/sh

# Script for building and packaging Alpine packages
# Usage build-package [7.1|7.2] [package-name]

PHP_VER="${1:-7.1}"
PACKAGE="${2:-litespeed}"

case "$PHP_VER" in
	7.1)

	;;
	7.2)

	;;
esac

# We'll need some deps from the PHP.earth Alpine repository
# Make the PHP.earth Alpine repository trusted
sudo wget -O /etc/apk/keys/phpearth.rsa.pub https://alpine.php.earth/phpearth.rsa.pub
# Get the url of the repository
sudo echo "https://alpine.php.earth/$PHP_VER" | sudo tee -a /etc/apk/repositories
sudo apk update

cd /build/$PHP_VER/$PACKAGE

abuild -P . checksum
abuild -P . unpack
abuild -P . deps
# Apply patches
abuild -P . prepare
abuild -P . build
# Run tests - curently disabled
#abuild -P . check
abuild -P . rootpkg
cp pkg/.control.*/$PHP_VER/x86_64/*.apk /repo/$PHP_VER/x86_64/
